##
# StdAir documentation (HTML, PDF, RTF), to be generated by Doxygen
#

# Define the substitutes for the variables present in the Doxygen
# configuration file. Note that PACKAGE, PACKAGE_NAME and PACKAGE_VERSION
# are defined in the main CMakeLists.txt (of the top root directory).
set (OUTPUT_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR})
set (top_srcdir       ${CMAKE_SOURCE_DIR})
set (srcdir           ${CMAKE_CURRENT_SOURCE_DIR})

# Convert the Doxygen configuration files (basically, just replace
# the @<variable>@ variables).
set (DOXYGEN_CFG_SRC doxygen_html.cfg.in)
set (DOXYGEN_CFG ${CMAKE_CURRENT_BINARY_DIR}/doxygen_html.cfg)
configure_file (${DOXYGEN_CFG_SRC} ${DOXYGEN_CFG} @ONLY)

## Documentation sources
# Images
set (docimages_DIR ${CMAKE_CURRENT_SOURCE_DIR}/images)
set (image_SOURCES ${CPACK_PACKAGE_NAME}_logo.png sfx_logo.png favicon.ico)
# Tutorial
FILE (GLOB doctutorial_SOURCES ${CMAKE_CURRENT_SOURCE_DIR}/tutorial/*.doc)
# Local
FILE (GLOB doclocaldoc_SOURCES ${CMAKE_CURRENT_SOURCE_DIR}/local/*.doc)
FILE (GLOB doclocalhtml_SOURCES ${CMAKE_CURRENT_SOURCE_DIR}/local/*.html)
set (doclocal_SOURCES ${doclocaldoc_SOURCES} ${doclocalhtml_SOURCES})
# Aggregating all the documentation sources
set (doc_SOURCES ${doctutorial_SOURCES} ${doclocal_SOURCES})

# Latex reference manual source (.tex file), generated by Doxygen
set (REFMAN refman)
set (TEX_GEN_DIR ${CMAKE_CURRENT_BINARY_DIR}/latex)
set (REFMAN_TEX ${REFMAN}.tex)
set (REFMAN_TEX_FULL ${TEX_GEN_DIR}/${REFMAN_TEX})

# Add the build rule for Doxygen
set (DOXYGEN_OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/html/index.html)
add_custom_command (OUTPUT ${DOXYGEN_OUTPUT} ${REFMAN_TEX_FULL}
  COMMAND ${DOXYGEN_EXECUTABLE} ARGS ${DOXYGEN_CFG}
  DEPENDS ${DOXYGEN_CFG} ${doc_SOURCES}
  COMMENT "Generating documentation with Doxygen, from '${DOXYGEN_CFG}'...")
# Add the 'doc' target, depending on the generated HTML documentation
add_custom_target (doc ALL DEPENDS ${DOXYGEN_OUTPUT})

# Copy the needed images into the generated HTML directory
set (htmldoc_DIR ${CMAKE_CURRENT_BINARY_DIR}/html)
set (pdfdoc_DIR ${CMAKE_CURRENT_BINARY_DIR}/latex)
foreach (image_SRC ${image_SOURCES})
  set (IMG_SRC_FULL_DIR ${docimages_DIR}/${image_SRC})
  set (IMG_GEN_FULL_DIR ${htmldoc_DIR}/${image_SRC})
  add_custom_command (OUTPUT ${IMG_GEN_FULL_DIR}
	COMMAND ${CMAKE_COMMAND} 
	ARGS -E copy ${IMG_SRC_FULL_DIR} ${IMG_GEN_FULL_DIR}
	DEPENDS ${DOXYGEN_OUTPUT} ${IMG_SRC_FULL_DIR}
	COMMENT "Copying image '${IMG_SRC_FULL_DIR}' into '${htmldoc_DIR}'...")
  add_custom_target (img_${image_SRC} ALL DEPENDS ${IMG_GEN_FULL_DIR})
endforeach (image_SRC)

##
# PDF, generated by (Pdf)Latex from the Latex source file, itself generated
# by Doxygen (see above)
set (REFMAN_IDX ${REFMAN}.idx)
set (REFMAN_PDF ${REFMAN}.pdf)
set (REFMAN_PDF_FULL ${TEX_GEN_DIR}/${REFMAN_PDF})
# Note the "|| echo" addition to the pdflatex command, as that latter returns
# as if there were an error.
add_custom_command (OUTPUT ${REFMAN_PDF_FULL}
  DEPENDS ${DOXYGEN_OUTPUT} ${REFMAN_TEX_FULL}
  COMMAND ${CMAKE_COMMAND} 
  ARGS -E chdir ${TEX_GEN_DIR} pdflatex -interaction batchmode ${REFMAN_TEX} || echo "First PDF generation done."
  COMMAND ${CMAKE_COMMAND} 
  ARGS -E chdir ${TEX_GEN_DIR} makeindex -q ${REFMAN_IDX}
  COMMAND ${CMAKE_COMMAND} 
  ARGS -E chdir ${TEX_GEN_DIR} pdflatex -interaction batchmode ${REFMAN_TEX} || echo "Second PDF generation done."
  COMMENT "Generating PDF Reference Manual ('${REFMAN_PDF}')...")
# Add the 'pdf' target, depending on the generated PDF manual
add_custom_target (pdf ALL DEPENDS ${REFMAN_PDF_FULL})

# Clean-up $build/html and $build/latex on 'make clean'
set_property (DIRECTORY APPEND PROPERTY ADDITIONAL_MAKE_CLEAN_FILES 
  ${htmldoc_DIR} ${pdfdoc_DIR})

# Installation of the HTML documentation
set (DOC_PATH share/doc/${PROJECT_NAME}-${CPACK_PACKAGE_VERSION})
install (DIRECTORY ${htmldoc_DIR} DESTINATION ${DOC_PATH})
install (FILES ${TEX_GEN_DIR}/${REFMAN_PDF}
  DESTINATION ${DOC_PATH}/html)
